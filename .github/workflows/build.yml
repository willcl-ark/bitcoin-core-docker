name: bake

on:
  workflow_dispatch:
    inputs:
      targets:
        description: 'Bake targets (e.g., "v29_2_all", "releases", "all")'
        required: false
        default: ''
      push:
        description: 'Push images to registry'
        required: false
        default: false
        type: boolean
  pull_request:
    paths:
      # Match version directories (e.g., 30.1/**, 29.2rc1/**)
      - '[0-9][0-9].[0-9]/**'
      - '[0-9][0-9].[0-9]rc[0-9]/**'
      - 'docker-bake.hcl'
  push:
    branches:
      - master
    paths:
      - '[0-9][0-9].[0-9]/**'
      - '[0-9][0-9].[0-9]rc[0-9]/**'
      - 'docker-bake.hcl'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      targets: ${{ steps.detect.outputs.targets }}
      has_targets: ${{ steps.detect.outputs.has_targets }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect changed targets
        id: detect
        run: |
          # For manual dispatch, use provided targets or default to releases
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGETS="${{ github.event.inputs.targets }}"
            if [[ -z "$TARGETS" ]]; then
              TARGETS="releases"
            fi
            echo "targets=$TARGETS" >> $GITHUB_OUTPUT
            echo "has_targets=true" >> $GITHUB_OUTPUT
            echo "Manual dispatch: building $TARGETS"
            exit 0
          fi

          # Get changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          TARGETS=""

          # Dynamically find version directories (match X.Y or X.YrcN patterns, exclude deprecated/master)
          VERSION_DIRS=$(find . -maxdepth 1 -type d -regextype posix-extended -regex '\./[0-9]+\.[0-9]+(rc[0-9]+)?' | sed 's|^\./||' | sort -V)
          echo "Found version directories: $VERSION_DIRS"

          # Check each version directory
          for version in $VERSION_DIRS; do
            # Convert dots and 'rc' to underscores for bake target names
            version_underscore=$(echo "$version" | sed 's/\./_/g; s/rc/_rc/g')

            # Check if any files in this version directory changed
            if echo "$CHANGED_FILES" | grep -q "^${version}/"; then
              # Determine if it's alpine, debian, or both
              HAS_ALPINE=$(echo "$CHANGED_FILES" | grep -q "^${version}/alpine/" && echo "true" || echo "false")
              HAS_DEBIAN=$(echo "$CHANGED_FILES" | grep -qE "^${version}/(Dockerfile|docker-entrypoint)" && echo "true" || echo "false")

              # If docker-bake.hcl changed or unclear, build both
              if echo "$CHANGED_FILES" | grep -q "docker-bake.hcl"; then
                TARGETS="${TARGETS} v${version_underscore}_all"
              elif [[ "$HAS_ALPINE" == "true" && "$HAS_DEBIAN" == "true" ]]; then
                TARGETS="${TARGETS} v${version_underscore}_all"
              elif [[ "$HAS_ALPINE" == "true" ]]; then
                TARGETS="${TARGETS} v${version_underscore}_alpine"
              elif [[ "$HAS_DEBIAN" == "true" ]]; then
                TARGETS="${TARGETS} v${version_underscore}"
              else
                # Other files in the directory - build both to be safe
                TARGETS="${TARGETS} v${version_underscore}_all"
              fi
            fi
          done

          # If only docker-bake.hcl changed (no version dirs), validate syntax only
          if [[ -z "$TARGETS" ]] && echo "$CHANGED_FILES" | grep -q "docker-bake.hcl"; then
            echo "Only docker-bake.hcl changed - will validate syntax"
            echo "targets=" >> $GITHUB_OUTPUT
            echo "has_targets=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Trim leading space
          TARGETS="${TARGETS# }"

          if [[ -z "$TARGETS" ]]; then
            echo "No relevant changes detected"
            echo "targets=" >> $GITHUB_OUTPUT
            echo "has_targets=false" >> $GITHUB_OUTPUT
          else
            echo "Detected targets: $TARGETS"
            echo "targets=$TARGETS" >> $GITHUB_OUTPUT
            echo "has_targets=true" >> $GITHUB_OUTPUT
          fi

  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate bake file
        run: docker buildx bake --print

  build:
    needs: [detect-changes, validate]
    if: needs.detect-changes.outputs.has_targets == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine if push
        id: push
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "push=${{ github.event.inputs.push }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "push=true" >> $GITHUB_OUTPUT
          else
            echo "push=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        if: steps.push.outputs.push == 'true'
        uses: docker/login-action@v3
        with:
          username: bitcoin
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build images
        uses: docker/bake-action@v5
        env:
          PUSH: ${{ steps.push.outputs.push }}
        with:
          targets: ${{ needs.detect-changes.outputs.targets }}
          push: ${{ steps.push.outputs.push }}
